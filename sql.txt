-- Минимальная схема (как договорились: без status/created_by/etc.)

DROP TABLE IF EXISTS reviews;
DROP TABLE IF EXISTS places;

CREATE TABLE IF NOT EXISTS places (
  id            INTEGER PRIMARY KEY AUTOINCREMENT,
  name          TEXT    NOT NULL,
  category      TEXT    NOT NULL,
  city          TEXT    NOT NULL,
  address       TEXT    NOT NULL DEFAULT '',
  description   TEXT,
  created_at    TEXT    NOT NULL DEFAULT (datetime('now')),
  avg_rating    REAL    NOT NULL DEFAULT 0.0,
  reviews_count INTEGER NOT NULL DEFAULT 0
);

CREATE INDEX IF NOT EXISTS ix_places_city     ON places(city);
CREATE INDEX IF NOT EXISTS ix_places_category ON places(category);
CREATE INDEX IF NOT EXISTS ix_places_category_city ON places(category, city);
CREATE INDEX IF NOT EXISTS ix_places_avg_rating ON places(avg_rating);

CREATE TABLE IF NOT EXISTS reviews (
  id         INTEGER PRIMARY KEY AUTOINCREMENT,
  place_id   INTEGER NOT NULL,
  user_id    TEXT    NOT NULL,
  rating     INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  text       TEXT,
  created_at TEXT    NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (place_id) REFERENCES places(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS ix_reviews_place_id ON reviews(place_id);
CREATE INDEX IF NOT EXISTS ix_reviews_place_created_at ON reviews(place_id, created_at);
